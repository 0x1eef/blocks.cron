#!/bin/sh -e

##
# variables
user="_blocks"
localbase=$($(dirname "$0")/dirname "$0" 3)
homedir="${localbase}"/share/blocks+cron/home/"${user}"

##
# main
# shellcheck disable=SC1091
if ! id "${user}" > /dev/null 2>&1; then
    if [ "$(uname)" = "OpenBSD" ]; then
        useradd \
            -s "/sbin/nologin" \
            -c "${user} user account" \
            -d "/home/${user}" \
            -mk "${homedir}" \
            "${user}"
        echo "[+] ${user} user and group created successfully"
    elif [ "$(uname)" = "FreeBSD" ]; then
        pw useradd \
            -s "/sbin/nologin" \
            -c "${user} user account" \
            -d "/home/${user}" \
            -mk "${homedir}" \
            -n "${user}"
        echo "[+] ${user} user and group created successfully"
    else
        echo "[x] $(uname) is not supported"
        exit 1
    fi
else
    echo "[+] ${user} user already exists"
    if [ ! -e "/home/${user}" ]; then
        mkdir /home/${user}
    fi
    find "${homedir}" \
          -mindepth 1 \
          -maxdepth 1 \
          -exec cp -Rf {} /home/${user}/ \;
fi

find /home/"${user}" \
    -type d \
    -exec chown _blocks:_blocks {} \; \
    -exec chmod u=rwx,g=rx,o= {} \;
find /home/"${user}" \
    -type f \
    -exec chown _blocks:_blocks {} \; \
    -exec chmod u=rw,g=r,o= {} \;
find /home/"${user}"/.local/libexec \
    -type f \
    -exec chown root:_blocks {} \; \
    -exec chmod ug=rx,o= {} \;
find /home/"${user}"/bin \
    -type f \
    -exec chmod ug=rx,o= {} \;
find /home/"${user}" \
    -type f \
    -name .gitkeep \
    -exec rm {} \;
echo "[+] /home/${user} setup"
